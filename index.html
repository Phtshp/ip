<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IP‑калькулятор (авто + таблица масок)</title>
  <style>
    body { margin:16px; font-family: Arial, sans-serif; color:#111; }
    label { display:block; margin-top:8px; font-weight:600; }
    input, button { font:inherit; margin-top:6px; }
    input[type="text"], input[type="search"], input[type="number"] { width:100%; padding:6px; box-sizing:border-box; }
    .hidden { display:none; }
    pre { background:#f7f7f7; padding:8px; overflow:auto; margin:8px 0; }
    table { border-collapse:collapse; margin-top:8px; width:100%; }
    th, td { text-align:left; padding:6px 8px; vertical-align:top; font-family:monospace; border-bottom:1px solid #eee; }
    th { background:#f2f2f2; font-weight:700; font-family:inherit; }
    .small { font-size:90%; color:#444; }
    .error { color:#b00; margin-top:6px; }
    .controls { margin-top:8px; }
    button { padding:6px 10px; margin-right:6px; }
    .muted { color:#666; font-size:90%; }

    .result-table { table-layout: fixed; width:100%; }
    .result-table col:first-child, .result-table th:first-child { width:220px; white-space:nowrap; font-family:inherit; }
    .result-table th, .result-table td { padding:10px 18px; }
    .result-table td { white-space:normal; overflow-wrap:anywhere; font-family:monospace; }

    /* Slightly increased masks table width compared to previous */
    .mask-table { table-layout: auto; width:1240px; max-width:100%; font-size:15px; margin:0; }
    .mask-table th, .mask-table td { font-family:monospace; padding:6px 9px; border-bottom:1px solid #eee; }
    .mask-table th { background:#f2f2f2; font-weight:700; font-family:inherit; }
    .mask-table td { white-space:normal; word-break:break-word; }
    @media (max-width:1200px){
      .mask-table { width:100%; font-size:14px; }
      .result-table th, .result-table td { padding:8px 12px; }
    }
    @media (max-width:700px){
      .mask-table { font-size:13px; }
    }

    .masks-wrap { overflow:auto; }
    .masks-container { max-width:1240px; }
  </style>
</head>
<body>
  <h1>IP‑калькулятор</h1>

  <label for="input">IP / маска</label>
  <input id="input" type="search" placeholder="192.168.1.10/24 или 192.168.1.10 255.255.255.0" />

  <div class="controls">
    <button id="clearBtn">Очистить</button>
    <button id="copyBtn">Копировать</button>
    <button id="advToggle" aria-expanded="false">Расширенные (показать)</button>
    <button id="masksToggle" aria-expanded="false">Таблица масок (показать)</button>
  </div>

  <div id="error" class="error" role="alert" aria-live="assertive"></div>

  <div id="advanced" class="hidden" style="margin-top:10px;">
    <label for="hostIndex" class="small">Номер хоста (только число, например <code>1</code> — первый usable)</label>
    <input id="hostIndex" type="number" min="1" placeholder="1" />
    <div style="margin-top:6px;">
      <span id="hostError" class="error"></span>
    </div>
    <div id="hostResult" class="small hidden" style="margin-top:6px;">Запрошенный хост: <span id="r-host">-</span></div>
  </div>

  <section id="result" class="hidden" aria-live="polite" style="margin-top:12px;">
    <h2 style="margin:0 0 6px 0;">Результаты</h2>
    <table class="result-table" aria-label="Таблица результатов">
      <colgroup>
        <col />
        <col />
      </colgroup>
      <tbody>
        <tr><th>IP</th><td id="r-ip"></td></tr>
        <tr><th>Тип адреса</th><td id="r-type"></td></tr>
        <tr><th>Сеть</th><td id="r-network"></td></tr>
        <tr><th>Broadcast</th><td id="r-broadcast"></td></tr>
        <tr><th>Префикс</th><td id="r-prefix"></td></tr>
        <tr><th>Маска</th><td id="r-netmask"></td></tr>
        <tr><th>Битовая форма маски</th><td id="r-maskbits"></td></tr>
        <tr><th>Wildcard</th><td id="r-wildcard"></td></tr>
        <tr><th>Всего адресов</th><td id="r-total"></td></tr>
        <tr><th>Usable</th><td id="r-usable"></td></tr>
        <tr><th>Первый usable</th><td id="r-first"></td></tr>
        <tr><th>Последний usable</th><td id="r-last"></td></tr>
      </tbody>
    </table>

    <h3 style="margin-top:8px; margin-bottom:4px;">Бинарные представления</h3>
    <pre id="binary">
IP:      <span id="b-ip"></span>
Netmask: <span id="b-netmask"></span>
Network: <span id="b-network"></span>
Broad:   <span id="b-broadcast"></span>
    </pre>
  </section>

  <section id="masksSection" class="hidden" style="margin-top:14px;">
    <h2 style="margin:0 0 8px 0;">Таблица масок подсетей</h2>
    <div class="muted small">Колонки: префикс, маска (десятичная), шаг сети, количество usable, количество адресов, битовая форма, обратная (wildcard).</div>
    <div class="masks-wrap" style="margin-top:8px;">
      <div class="masks-container">
        <table id="masksTable" class="mask-table" aria-label="Таблица масок">
          <thead>
            <tr>
              <th>Префикс</th>
              <th>Маска</th>
              <th>Шаг сети</th>
              <th>Кол-во usable</th>
              <th>Кол-во адресов</th>
              <th>Битовая форма</th>
              <th>Обратная</th>
            </tr>
          </thead>
          <tbody id="masksBody"></tbody>
        </table>
      </div>
    </div>
  </section>

<script>
(function(){
  'use strict';
  document.addEventListener('DOMContentLoaded', function(){
    var el = function(id){ return document.getElementById(id); };
    var input = el('input');
    var clearBtn = el('clearBtn');
    var copyBtn = el('copyBtn');
    var advToggle = el('advToggle');
    var advanced = el('advanced');
    var hostIndexInput = el('hostIndex');
    var hostError = el('hostError');
    var hostResult = el('hostResult');
    var rHost = el('r-host');
    var errorEl = el('error');
    var resultSection = el('result');
    var masksToggle = el('masksToggle');
    var masksSection = el('masksSection');
    var masksBody = el('masksBody');
    if(!input || !clearBtn || !errorEl || !resultSection || !copyBtn || !advToggle || !advanced || !hostIndexInput || !hostError || !hostResult || !rHost || !masksToggle || !masksSection || !masksBody){
      console.error('Некоторые элементы не найдены');
      return;
    }

    var lastResult = null;
    var debounceTimer = null;
    function debounce(fn, ms){
      return function(){
        var ctx = this, args = arguments;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function(){ fn.apply(ctx, args); }, ms);
      };
    }

    function showError(msg){ errorEl.textContent = msg || ''; }

    function ipToInt(ip){
      if(typeof ip !== 'string') return null;
      var p = ip.trim().split('.');
      if(p.length !==4) return null;
      var nums = [];
      for(var i=0;i<4;i++){
        if(!/^\d+$/.test(p[i])) return null;
        var n = Number(p[i]);
        if(n<0||n>255) return null;
        nums.push(n);
      }
      return ((nums[0]<<24)>>>0) + ((nums[1]<<16)>>>0) + ((nums[2]<<8)>>>0) + (nums[3]>>>0);
    }

    function intToIp(i){
      i = i>>>0;
      return ((i>>>24)&255)+'.'+((i>>>16)&255)+'.'+((i>>>8)&255)+'.'+(i&255);
    }

    function maskFromPrefix(prefix){
      if(!Number.isInteger(prefix) || prefix<0 || prefix>32) return null;
      return (prefix===0) ? 0 : (0xFFFFFFFF << (32 - prefix)) >>> 0;
    }

    function prefixFromMaskStr(msk){
      if(typeof msk !== 'string') return null;
      msk = msk.trim();
      if(msk === '') return null;
      if(msk.indexOf('.') !== -1){
        var m = ipToInt(msk);
        if(m===null) return null;
        var cnt=0;
        for(var i=0;i<32;i++){
          if((m & (1 << (31-i))) !== 0) cnt++;
        }
        var rebuilt = maskFromPrefix(cnt);
        if(rebuilt !== m) return null;
        return cnt;
      }
      var n = Number(msk);
      if(!Number.isInteger(n) || n<0 || n>32) return null;
      return n;
    }

    function toBinaryStr(i){
      return intToIp(i).split('.').map(function(o){ return ('00000000'+parseInt(o,10).toString(2)).slice(-8); }).join('.');
    }
    function toBitsCompact(i){ return ((i>>>0).toString(2)).padStart(32,'0'); }

    function parseTextInput(s){
      if(typeof s !== 'string') return null;
      s = s.trim();
      if(!s) return null;
      if(s.indexOf('/') !== -1){
        var idx = s.indexOf('/');
        var ipStr = s.substring(0, idx).trim();
        var prefStr = s.substring(idx+1).trim();
        var ipi = ipToInt(ipStr);
        var pref = Number(prefStr);
        if(ipi===null || !Number.isInteger(pref) || pref<0 || pref>32) return null;
        return { ipInt:ipi, prefix:pref };
      } else if(s.indexOf(' ') !== -1){
        var parts = s.split(/\s+/);
        var ipS = parts[0];
        var maskS = parts[1];
        var ii = ipToInt(ipS);
        var pr = prefixFromMaskStr(maskS);
        if(ii===null || pr===null) return null;
        return { ipInt:ii, prefix:pr };
      } else {
        var ii2 = ipToInt(s);
        if(ii2===null) return null;
        return { ipInt:ii2, prefix:32 };
      }
    }

    function addressType(ipInt){
      var inRange = function(start, prefix, ip){
        var mask = maskFromPrefix(prefix);
        return ((ip & mask) >>> 0) === (start >>> 0);
      };
      var ip = ipInt >>> 0;
      if(inRange(ipToInt('10.0.0.0'), 8, ip)) return 'Локальный (10.0.0.0/8)';
      if(inRange(ipToInt('172.16.0.0'), 12, ip)) return 'Локальный (172.16.0.0/12)';
      if(inRange(ipToInt('192.168.0.0'), 16, ip)) return 'Локальный (192.168.0.0/16)';
      if(inRange(ipToInt('127.0.0.0'), 8, ip)) return 'Локальный (loopback)';
      if(inRange(ipToInt('169.254.0.0'), 16, ip)) return 'Локальный (link-local)';
      if(inRange(ipToInt('100.64.0.0'), 10, ip)) return 'Локальный (CGNAT)';
      if(inRange(ipToInt('224.0.0.0'), 4, ip)) return 'Специальный (multicast/reserved)';
      if(inRange(ipToInt('240.0.0.0'), 4, ip)) return 'Специальный (reserved)';
      return 'Публичный (из интернета)';
    }

    function calc(ipInt, prefix){
      var mask = maskFromPrefix(prefix);
      var network = (ipInt & mask) >>> 0;
      var wildcard = (~mask) >>> 0;
      var broadcast = (network | wildcard) >>> 0;
      var total = (prefix===32) ? 1 : Math.pow(2, 32 - prefix);
      var usable, first, last;
      if(prefix===32){
        usable = 1; first = ipInt; last = ipInt;
      } else if(prefix===31){
        usable = 2; first = network; last = broadcast;
      } else {
        usable = total >= 2 ? total - 2 : 0;
        first = (network + 1) >>> 0;
        last = (broadcast - 1) >>> 0;
      }
      return {
        ip: intToIp(ipInt),
        ipInt: ipInt >>> 0,
        type: addressType(ipInt),
        network: intToIp(network),
        broadcast: intToIp(broadcast),
        prefix: prefix,
        netmask: intToIp(mask),
        maskBits: toBitsCompact(mask),
        wildcard: intToIp(wildcard),
        total: total,
        usable: usable,
        firstInt: first >>> 0,
        lastInt: last >>> 0,
        first: usable>0 ? intToIp(first) : '-',
        last: usable>0 ? intToIp(last) : '-',
        bin: {
          ip: toBinaryStr(ipInt),
          netmask: toBinaryStr(mask),
          network: toBinaryStr(network),
          broadcast: toBinaryStr(broadcast)
        }
      };
    }

    function render(res){
      if(!res) return;
      el('r-ip').textContent = res.ip;
      el('r-type').textContent = res.type;
      el('r-network').textContent = res.network;
      el('r-broadcast').textContent = res.broadcast;
      el('r-prefix').textContent = '/' + res.prefix;
      el('r-netmask').textContent = res.netmask;
      el('r-maskbits').textContent = res.maskBits;
      el('r-wildcard').textContent = res.wildcard;
      el('r-total').textContent = String(res.total);
      el('r-usable').textContent = String(res.usable);
      el('r-first').textContent = res.first;
      el('r-last').textContent = res.last;
      el('b-ip').textContent = res.bin.ip;
      el('b-netmask').textContent = res.bin.netmask;
      el('b-network').textContent = res.bin.network;
      el('b-broadcast').textContent = res.bin.broadcast;
      resultSection.classList.remove('hidden');
    }

    function buildMasksTable(){
      masksBody.innerHTML = '';
      for(var p=0;p<=32;p++){
        var maskInt = maskFromPrefix(p);
        var maskDotted = intToIp(maskInt);
        var maskBits = toBitsCompact(maskInt);
        var wildcardInt = (~maskInt) >>> 0;
        var wildcard = intToIp(wildcardInt);
        var total = (p===32) ? 1 : Math.pow(2, 32 - p);
        var usable;
        if(p===32) usable = 1;
        else if(p===31) usable = 2;
        else usable = total >= 2 ? total - 2 : 0;
        var maskParts = maskDotted.split('.').map(function(x){ return Number(x); });
        var octetIndex = -1;
        for(var i=0;i<4;i++){ if(maskParts[i] !== 255){ octetIndex = i; break; } }
        var stepVal, stepStr;
        if(octetIndex === -1){
          stepVal = 1;
          stepStr = '1 (в 4-м октете)';
        } else {
          stepVal = 256 - maskParts[octetIndex];
          stepStr = stepVal + ' (в ' + (octetIndex + 1) + '-м октете)';
        }
        var tr = document.createElement('tr');
        var tdPrefix = document.createElement('td'); tdPrefix.textContent = '/' + p; tr.appendChild(tdPrefix);
        var tdMask = document.createElement('td'); tdMask.textContent = maskDotted; tr.appendChild(tdMask);
        var tdStep = document.createElement('td'); tdStep.textContent = stepStr; tr.appendChild(tdStep);
        var tdUsable = document.createElement('td'); tdUsable.textContent = String(usable); tr.appendChild(tdUsable);
        var tdTotal = document.createElement('td'); tdTotal.textContent = String(total); tr.appendChild(tdTotal);
        var tdBits = document.createElement('td'); tdBits.textContent = maskBits; tr.appendChild(tdBits);
        var tdWildcard = document.createElement('td'); tdWildcard.textContent = wildcard; tr.appendChild(tdWildcard);
        masksBody.appendChild(tr);
      }
    }

    input.addEventListener('input', debounce(function(){
      showError('');
      hostError.textContent = '';
      hostResult.classList.add('hidden');
      rHost.textContent = '-';
      var parsed = parseTextInput(input.value || '');
      if(!parsed){
        if((input.value || '').trim() !== '') showError('Неверный ввод. Формат: 192.168.1.10/24 или 192.168.1.10 255.255.255.0');
        resultSection.classList.add('hidden');
        lastResult = null;
        return;
      }
      try {
        var res = calc(parsed.ipInt, parsed.prefix);
        lastResult = res;
        render(res);
      } catch(e){
        console.error(e);
        showError('Ошибка вычисления');
      }
    }, 300));

    input.addEventListener('paste', function(){ setTimeout(function(){ input.dispatchEvent(new Event('input')); }, 50); });

    hostIndexInput.addEventListener('input', function(){
      hostError.textContent = '';
      rHost.textContent = '-';
      hostResult.classList.add('hidden');
      if(!lastResult) return;
      var v = String(hostIndexInput.value || '').trim();
      if(!/^[1-9]\d*$/.test(v)){
        hostError.textContent = v === '' ? '' : 'Индекс должен быть положительным целым числом';
        return;
      }
      var idx = Number(v);
      var first = lastResult.firstInt, last = lastResult.lastInt;
      var target = (first + (idx - 1)) >>> 0;
      if(target > last){
        hostError.textContent = 'Индекс вне диапазона usable адресов';
        rHost.textContent = '-';
        hostResult.classList.remove('hidden');
        return;
      }
      rHost.textContent = intToIp(target) + ' (#' + idx + ' от первого usable)';
      hostResult.classList.remove('hidden');
    });

    clearBtn.addEventListener('click', function(){
      input.value = '';
      hostIndexInput.value = '';
      showError('');
      hostError.textContent = '';
      rHost.textContent = '-';
      hostResult.classList.add('hidden');
      resultSection.classList.add('hidden');
      lastResult = null;
    });

    advToggle.addEventListener('click', function(){
      var expanded = advToggle.getAttribute('aria-expanded') === 'true';
      advToggle.setAttribute('aria-expanded', String(!expanded));
      advToggle.textContent = expanded ? 'Расширенные (показать)' : 'Расширенные (скрыть)';
      if(advanced.classList.contains('hidden')) advanced.classList.remove('hidden'); else advanced.classList.add('hidden');
    });

    copyBtn.addEventListener('click', function(){
      if(!lastResult){ showError('Сначала введите корректный IP.'); return; }
      var rows = [
        ['IP', el('r-ip').textContent],
        ['Type', el('r-type').textContent],
        ['Network', el('r-network').textContent],
        ['Broadcast', el('r-broadcast').textContent],
        ['Prefix', el('r-prefix').textContent],
        ['Netmask', el('r-netmask').textContent],
        ['Mask bits', el('r-maskbits').textContent],
        ['Wildcard', el('r-wildcard').textContent],
        ['Total', el('r-total').textContent],
        ['Usable', el('r-usable').textContent],
        ['First', el('r-first').textContent],
        ['Last', el('r-last').textContent],
        ['Requested host', rHost.textContent || '-'],
        ['Binary IP', el('b-ip').textContent],
        ['Binary Netmask', el('b-netmask').textContent]
      ];
      var txt = rows.map(function(r){ return r[0]+':\t'+r[1]; }).join('\n');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(function(){ copyBtn.textContent='Скопировано!'; setTimeout(function(){ copyBtn.textContent='Копировать'; },1000); }).catch(function(){ var ta=document.createElement('textarea'); ta.value=txt; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); });
      } else { var ta=document.createElement('textarea'); ta.value=txt; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    });

    masksToggle.addEventListener('click', function(){
      var expanded = masksToggle.getAttribute('aria-expanded') === 'true';
      masksToggle.setAttribute('aria-expanded', String(!expanded));
      masksToggle.textContent = expanded ? 'Таблица масок (показать)' : 'Таблица масок (скрыть)';
      if(masksSection.classList.contains('hidden')){
        masksSection.classList.remove('hidden');
        if(masksBody.children.length === 0) buildMasksTable();
      } else {
        masksSection.classList.add('hidden');
      }
    });

    if((input.value || '').trim() !== '') input.dispatchEvent(new Event('input'));
    input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ input.dispatchEvent(new Event('input')); e.preventDefault(); } });
  });
})();
</script>
</body>
</html>